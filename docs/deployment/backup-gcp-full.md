# üìã CATATAN BACKUP GCP FULL - Chill Ajar Backend
## üöÄ Panduan Lengkap Backup & Restore untuk Google Cloud Platform

---

## üéØ **OVERVIEW APLIKASI**

### **üì± Aplikasi:** Chill Ajar - Learning Management System
```
üèóÔ∏è Framework: Laravel 12 (PHP 8.2+)
üóÑÔ∏è Database: MySQL/PostgreSQL + Redis Cache
üì¶ Package Manager: Composer + NPM
üåê Web Server: Nginx + PHP-FPM
üì≤ Additional: Node.js WhatsApp Gateway (Port 3000)
üìÅ Storage: Local file storage (uploads)
```

### **üîß Tech Stack:**
```
Backend: Laravel 12 + Sanctum Auth
Database: MySQL 8.0 / PostgreSQL 16
Cache: Redis 6.x
Frontend: Vite + TailwindCSS 4.0
Gateway: Node.js WhatsApp Web.js
Server: Ubuntu 22.04 LTS (GCP VM)
```

---

## üíæ **1. DATABASE BACKUP**

### **üóÑÔ∏è MySQL Backup**
```bash
#!/bin/bash
# Script: backup_mysql.sh

# Variables
DB_NAME="db_manpro_sizzlingchilli_backend_chill"
DB_USER="dev_chill_ajar"
DB_PASS="Manpro2025!"
BACKUP_DIR="/home/backup/mysql"
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/backup_chillajar_$DATE.sql"

# Create backup directory
mkdir -p $BACKUP_DIR

# Full database backup with structure + data
mysqldump -u $DB_USER -p$DB_PASS \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  --hex-blob \
  --opt \
  $DB_NAME > $BACKUP_FILE

# Compress backup
gzip $BACKUP_FILE

# Keep only last 7 days
find $BACKUP_DIR -name "backup_chillajar_*.sql.gz" -mtime +7 -delete

echo "‚úÖ MySQL backup completed: $BACKUP_FILE.gz"
```

### **üêò PostgreSQL Backup**
```bash
#!/bin/bash
# Script: backup_postgresql.sh

# Variables
DB_NAME="db_manpro_sizzlingchilli_backend_chill"
DB_USER="deploy_dev"
BACKUP_DIR="/home/backup/postgresql"
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/backup_chillajar_$DATE.sql"

# Create backup directory
mkdir -p $BACKUP_DIR

# Full database backup
pg_dump -h localhost -U $DB_USER -d $DB_NAME \
  --clean \
  --create \
  --if-exists \
  --verbose \
  --file=$BACKUP_FILE

# Compress backup
gzip $BACKUP_FILE

# Keep only last 7 days
find $BACKUP_DIR -name "backup_chillajar_*.sql.gz" -mtime +7 -delete

echo "‚úÖ PostgreSQL backup completed: $BACKUP_FILE.gz"
```

---

## üìÅ **2. FILE SYSTEM BACKUP**

### **üóÇÔ∏è Application Files Backup**
```bash
#!/bin/bash
# Script: backup_files.sh

# Variables
APP_DIR="/home/ekomh13/manpro-sizzlingchilli-backend-chill-ajar"
BACKUP_DIR="/home/backup/files"
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/backup_app_files_$DATE.tar.gz"

# Create backup directory
mkdir -p $BACKUP_DIR

# Application files backup (exclude vendor, node_modules, cache)
tar -czf $BACKUP_FILE \
  --exclude="$APP_DIR/vendor" \
  --exclude="$APP_DIR/node_modules" \
  --exclude="$APP_DIR/storage/logs/*" \
  --exclude="$APP_DIR/storage/framework/cache/*" \
  --exclude="$APP_DIR/storage/framework/sessions/*" \
  --exclude="$APP_DIR/storage/framework/views/*" \
  --exclude="$APP_DIR/.git" \
  $APP_DIR

echo "‚úÖ Application files backup completed: $BACKUP_FILE"
```

### **üì§ Uploads & Storage Backup**
```bash
#!/bin/bash
# Script: backup_storage.sh

# Variables
STORAGE_DIR="/home/ekomh13/manpro-sizzlingchilli-backend-chill-ajar/storage/app"
PUBLIC_DIR="/home/ekomh13/manpro-sizzlingchilli-backend-chill-ajar/public/storage"
BACKUP_DIR="/home/backup/storage"
DATE=$(date +"%Y%m%d_%H%M%S")

# Create backup directory
mkdir -p $BACKUP_DIR

# Storage backup (user uploads, photos, payment proofs)
tar -czf "$BACKUP_DIR/backup_storage_$DATE.tar.gz" \
  -C "/home/ekomh13/manpro-sizzlingchilli-backend-chill-ajar" \
  storage/app/public \
  storage/app/private \
  public/storage

echo "‚úÖ Storage backup completed: backup_storage_$DATE.tar.gz"
```

---

## ‚öôÔ∏è **3. CONFIGURATION BACKUP**

### **üîß System Configuration**
```bash
#!/bin/bash
# Script: backup_config.sh

BACKUP_DIR="/home/backup/config"
DATE=$(date +"%Y%m%d_%H%M%S")
CONFIG_BACKUP="$BACKUP_DIR/backup_config_$DATE.tar.gz"

mkdir -p $BACKUP_DIR

# Backup system configurations
tar -czf $CONFIG_BACKUP \
  /etc/nginx/sites-available/ \
  /etc/nginx/nginx.conf \
  /etc/php/8.3/fpm/ \
  /etc/mysql/mysql.conf.d/ \
  /etc/redis/ \
  /etc/crontab \
  /var/spool/cron/crontabs/ \
  /home/ekomh13/manpro-sizzlingchilli-backend-chill-ajar/.env

echo "‚úÖ Configuration backup completed: $CONFIG_BACKUP"
```

### **üìù Environment Variables Backup**
```bash
#!/bin/bash
# Script: backup_env.sh

APP_DIR="/home/ekomh13/manpro-sizzlingchilli-backend-chill-ajar"
BACKUP_DIR="/home/backup/env"
DATE=$(date +"%Y%m%d_%H%M%S")

mkdir -p $BACKUP_DIR

# Backup environment file (CAREFUL: Contains sensitive data!)
cp "$APP_DIR/.env" "$BACKUP_DIR/.env_backup_$DATE"
chmod 600 "$BACKUP_DIR/.env_backup_$DATE"

echo "‚úÖ Environment backup completed: .env_backup_$DATE"
echo "‚ö†Ô∏è  WARNING: File contains sensitive data - secure properly!"
```

---

## üåê **4. WHATSAPP GATEWAY BACKUP**

### **üì≤ WhatsApp Gateway Configuration**
```bash
#!/bin/bash
# Script: backup_whatsapp_gateway.sh

WA_DIR="/home/ekomh13/whatsapp-sizzlingchilli-gateway-chillajar"
BACKUP_DIR="/home/backup/whatsapp"
DATE=$(date +"%Y%m%d_%H%M%S")

mkdir -p $BACKUP_DIR

if [ -d "$WA_DIR" ]; then
  # Backup WhatsApp Gateway
  tar -czf "$BACKUP_DIR/backup_wa_gateway_$DATE.tar.gz" \
    --exclude="$WA_DIR/node_modules" \
    --exclude="$WA_DIR/.wwebjs_auth" \
    $WA_DIR
  
  # Backup PM2 configuration
  pm2 dump > "$BACKUP_DIR/pm2_processes_$DATE.json"
  
  echo "‚úÖ WhatsApp Gateway backup completed"
else
  echo "‚ö†Ô∏è  WhatsApp Gateway directory not found: $WA_DIR"
fi
```

---

## üîÑ **5. AUTOMATED BACKUP SCRIPT**

### **ü§ñ Master Backup Script**
```bash
#!/bin/bash
# Script: full_backup.sh
# Description: Complete backup for Chill Ajar Backend

set -e

echo "üöÄ Starting Full Backup Process..."
echo "üìÖ Date: $(date)"
echo "=================================="

# Variables
BACKUP_ROOT="/home/backup"
LOG_FILE="$BACKUP_ROOT/backup.log"
DATE=$(date +"%Y%m%d_%H%M%S")

# Create main backup directory
mkdir -p $BACKUP_ROOT

# Log function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a $LOG_FILE
}

log "üìã Starting backup process..."

# 1. Database Backup
log "üóÑÔ∏è  Starting database backup..."
if systemctl is-active --quiet mysql; then
    ./backup_mysql.sh
    log "‚úÖ MySQL backup completed"
elif systemctl is-active --quiet postgresql; then
    ./backup_postgresql.sh
    log "‚úÖ PostgreSQL backup completed"
else
    log "‚ùå No database service found"
fi

# 2. Application Files
log "üìÅ Starting application files backup..."
./backup_files.sh
log "‚úÖ Application files backup completed"

# 3. Storage & Uploads
log "üì§ Starting storage backup..."
./backup_storage.sh
log "‚úÖ Storage backup completed"

# 4. Configuration
log "‚öôÔ∏è  Starting configuration backup..."
./backup_config.sh
log "‚úÖ Configuration backup completed"

# 5. Environment Variables
log "üìù Starting environment backup..."
./backup_env.sh
log "‚úÖ Environment backup completed"

# 6. WhatsApp Gateway
log "üì≤ Starting WhatsApp Gateway backup..."
./backup_whatsapp_gateway.sh
log "‚úÖ WhatsApp Gateway backup completed"

# 7. Cleanup old backups (keep 30 days)
log "üßπ Cleaning up old backups..."
find $BACKUP_ROOT -type f -mtime +30 -delete
log "‚úÖ Cleanup completed"

# 8. Backup summary
TOTAL_SIZE=$(du -sh $BACKUP_ROOT | cut -f1)
log "üìä Backup completed successfully!"
log "üìÅ Total backup size: $TOTAL_SIZE"
log "üìç Location: $BACKUP_ROOT"

echo "=================================="
echo "‚úÖ Full backup process completed!"
echo "üìÑ Check log: $LOG_FILE"
```

---

## üìÖ **6. CRON AUTOMATION**

### **‚è∞ Crontab Setup**
```bash
# Edit crontab
sudo crontab -e

# Add backup schedules:

# Daily backup at 2 AM
0 2 * * * /home/backup/scripts/full_backup.sh >> /home/backup/cron.log 2>&1

# Weekly database-only backup (Sunday 1 AM)
0 1 * * 0 /home/backup/scripts/backup_mysql.sh >> /home/backup/cron.log 2>&1

# Monthly configuration backup (1st day, 3 AM)
0 3 1 * * /home/backup/scripts/backup_config.sh >> /home/backup/cron.log 2>&1
```

---

## üîß **7. RESTORE PROCEDURES**

### **üóÑÔ∏è Database Restore**

#### **MySQL Restore:**
```bash
#!/bin/bash
# Script: restore_mysql.sh

BACKUP_FILE="$1"
DB_NAME="db_manpro_sizzlingchilli_backend_chill"
DB_USER="dev_chill_ajar"
DB_PASS="Manpro2025!"

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup_file.sql.gz>"
    exit 1
fi

echo "‚ö†Ô∏è  WARNING: This will OVERWRITE the current database!"
echo "üìÅ Backup file: $BACKUP_FILE"
echo "üóÑÔ∏è  Database: $DB_NAME"
read -p "Continue? (y/N): " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
    # Decompress and restore
    gunzip -c $BACKUP_FILE | mysql -u $DB_USER -p$DB_PASS $DB_NAME
    echo "‚úÖ Database restored successfully!"
else
    echo "‚ùå Restore cancelled"
fi
```

#### **PostgreSQL Restore:**
```bash
#!/bin/bash
# Script: restore_postgresql.sh

BACKUP_FILE="$1"
DB_NAME="db_manpro_sizzlingchilli_backend_chill"
DB_USER="deploy_dev"

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup_file.sql.gz>"
    exit 1
fi

echo "‚ö†Ô∏è  WARNING: This will OVERWRITE the current database!"
read -p "Continue? (y/N): " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
    # Decompress and restore
    gunzip -c $BACKUP_FILE | psql -h localhost -U $DB_USER -d $DB_NAME
    echo "‚úÖ Database restored successfully!"
fi
```

### **üìÅ Application Restore**
```bash
#!/bin/bash
# Script: restore_app.sh

BACKUP_FILE="$1"
RESTORE_DIR="/home/ekomh13/manpro-sizzlingchilli-backend-chill-ajar-restore"

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup_file.tar.gz>"
    exit 1
fi

echo "üìÅ Extracting backup to: $RESTORE_DIR"
mkdir -p $RESTORE_DIR
tar -xzf $BACKUP_FILE -C $RESTORE_DIR

echo "‚úÖ Application files restored to: $RESTORE_DIR"
echo "üìù Next steps:"
echo "   1. Copy .env file and configure"
echo "   2. Run: composer install"
echo "   3. Run: php artisan migrate"
echo "   4. Set proper permissions"
echo "   5. Update Nginx configuration"
```

---

## üîê **8. SECURITY & BEST PRACTICES**

### **üõ°Ô∏è Backup Security**
```bash
# Encrypt sensitive backups
encrypt_backup() {
    local file="$1"
    local encrypted="${file}.gpg"
    
    gpg --symmetric --cipher-algo AES256 --output "$encrypted" "$file"
    rm "$file"  # Remove unencrypted version
    echo "üîê Backup encrypted: $encrypted"
}

# Decrypt backup
decrypt_backup() {
    local encrypted_file="$1"
    local decrypted="${encrypted_file%.gpg}"
    
    gpg --decrypt --output "$decrypted" "$encrypted_file"
    echo "üîì Backup decrypted: $decrypted"
}
```

### **‚òÅÔ∏è Cloud Storage Upload**
```bash
#!/bin/bash
# Upload to Google Cloud Storage

BUCKET_NAME="chillajar-backups"
LOCAL_BACKUP_DIR="/home/backup"
DATE=$(date +"%Y%m%d")

# Upload daily backup to GCS
gsutil -m cp -r "$LOCAL_BACKUP_DIR/backup_*$DATE*" "gs://$BUCKET_NAME/daily/"

# Clean local backups older than 7 days
find $LOCAL_BACKUP_DIR -type f -mtime +7 -delete

echo "‚òÅÔ∏è  Backup uploaded to Google Cloud Storage"
```

---

## üìã **9. DISASTER RECOVERY CHECKLIST**

### **üö® Emergency Recovery Steps**

#### **üî• Complete System Failure:**
```
1. ‚úÖ Spin up new GCP VM (Ubuntu 22.04 LTS)
2. ‚úÖ Install basic stack (Nginx, PHP 8.3, MySQL/PostgreSQL, Node.js)
3. ‚úÖ Download latest backup from Cloud Storage
4. ‚úÖ Restore database from backup
5. ‚úÖ Extract application files
6. ‚úÖ Configure .env file
7. ‚úÖ Run composer install
8. ‚úÖ Set file permissions (www-data)
9. ‚úÖ Configure Nginx virtual host
10. ‚úÖ Restore WhatsApp Gateway
11. ‚úÖ Update DNS if needed
12. ‚úÖ Test all functionality
```

#### **üóÑÔ∏è Database Corruption:**
```
1. ‚úÖ Stop application (maintenance mode)
2. ‚úÖ Backup corrupted database (for analysis)
3. ‚úÖ Restore from latest known good backup
4. ‚úÖ Run integrity checks
5. ‚úÖ Verify data consistency
6. ‚úÖ Resume application
7. ‚úÖ Monitor for issues
```

#### **üìÅ File System Issues:**
```
1. ‚úÖ Identify affected files/directories
2. ‚úÖ Stop web server
3. ‚úÖ Restore from file backup
4. ‚úÖ Reset permissions
5. ‚úÖ Clear application cache
6. ‚úÖ Restart services
7. ‚úÖ Verify functionality
```

---

## üìä **10. MONITORING & ALERTS**

### **üìà Backup Monitoring Script**
```bash
#!/bin/bash
# Script: monitor_backups.sh

BACKUP_DIR="/home/backup"
ALERT_EMAIL="admin@chillajar.com"
MAX_AGE_HOURS=26  # Alert if backup older than 26 hours

# Check latest backup age
LATEST_BACKUP=$(find $BACKUP_DIR -name "backup_*" -type f -printf '%T@ %p\n' | sort -nr | head -1 | cut -d' ' -f2-)
if [ -n "$LATEST_BACKUP" ]; then
    BACKUP_AGE=$(( ($(date +%s) - $(stat -c %Y "$LATEST_BACKUP")) / 3600 ))
    
    if [ $BACKUP_AGE -gt $MAX_AGE_HOURS ]; then
        echo "üö® ALERT: Latest backup is $BACKUP_AGE hours old!" | mail -s "Backup Alert - Chill Ajar" $ALERT_EMAIL
    fi
else
    echo "üö® ALERT: No backups found!" | mail -s "Backup Alert - Chill Ajar" $ALERT_EMAIL
fi

# Check backup sizes
TOTAL_SIZE=$(du -sh $BACKUP_DIR | cut -f1)
echo "üìä Total backup size: $TOTAL_SIZE"

# Check disk space
DISK_USAGE=$(df /home | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "‚ö†Ô∏è  Disk usage: $DISK_USAGE% - Consider cleanup" | mail -s "Disk Space Alert" $ALERT_EMAIL
fi
```

---

## üéØ **SUMMARY & KEY POINTS**

### **‚úÖ Backup Coverage:**
- üóÑÔ∏è **Database:** MySQL/PostgreSQL full dumps
- üìÅ **Application:** Source code + configurations
- üì§ **Storage:** User uploads & file storage
- ‚öôÔ∏è **System:** Nginx, PHP, MySQL configs
- üì≤ **Gateway:** WhatsApp Gateway setup
- üîê **Environment:** .env variables (encrypted)

### **üîÑ Automation:**
- üìÖ **Daily:** Full automated backup
- üìÖ **Weekly:** Database-only backup
- üìÖ **Monthly:** Configuration backup
- ‚òÅÔ∏è **Cloud Sync:** Upload to Google Cloud Storage

### **üõ°Ô∏è Security:**
- üîê Sensitive data encryption
- üîë Restricted file permissions
- üìß Monitoring & alerting
- üóÇÔ∏è Retention policies (30 days local, longer in cloud)

### **üöÄ Recovery Time:**
- **Database Only:** 15-30 minutes
- **Full Application:** 1-2 hours
- **Complete System:** 3-4 hours (including VM setup)

---

**üéØ CRITICAL REMINDER:** Test restore procedures regularly! A backup is only as good as your ability to restore from it!

*üìÖ Created: September 2025 | üîÑ Review: Monthly | üéØ Confidence: Production Ready*
    